#lang rosette/safe
(require "ir.rkt")
(require "rv-semantics.rkt")

(require (only-in racket
                  hash
                  make-hash
                  hash-has-key?
                  hash-ref
                  hash-set!
                  for
                  ))
(require rosette/lib/match)

(require rosette/solver/smt/z3)
(current-solver (z3 
  #:logic 'QF_AUFBV 
  #:options (hash
   ':parallel.enable 'true
   ':parallel.threads.max 16)))

(define-block riscv
(decl (14 (REGISTER 32 0 "pc"))
  (15 (MEMORY 32 5 "rf"))
  (16 (MEMORY 32 32 "dmem"))
  (17 (MEMORY 32 32 "imem"))
  (0 (HOLE 1 (list 37 51 48) "cont_mem_read_hole"))
  (1 (HOLE 1 (list 37 51 48) "cont_reg_write_src_hole"))
  (2 (HOLE 4 (list 37 51 48) "cont_alu_op_hole"))
  (3 (HOLE 1 (list 37 51 48) "cont_alu_pc_hole"))
  (4 (HOLE 3 (list 37 51 48) "cont_imm_type_hole"))
  (5 (HOLE 1 (list 37 51 48) "cont_target_hole"))
  (6 (HOLE 1 (list 37 51 48) "cont_jump_hole"))
  (7 (HOLE 1 (list 37 51 48) "cont_branch_inv_hole"))
  (8 (HOLE 1 (list 37 51 48) "cont_reg_write_hole"))
  (9 (HOLE 1 (list 37 51 48) "cont_mem_write_hole"))
  (10 (HOLE 1 (list 37 51 48) "cont_alu_imm_hole"))
  (11 (HOLE 1 (list 37 51 48) "cont_branch_hole"))
  (12 (HOLE 2 (list 37 51 48) "cont_mask_mode_hole"))
  (13 (HOLE 1 (list 37 51 48) "cont_mem_sign_ext_hole")))
(stmt (18 (CONST 0 16))
  (19 (SEL 14 (SLICE 2 31)))
  (20 (CONST 0 4))
  (21 (CONST 0 2))
  (22 (CONST 0 32))
  (23 (MUX (CONST 0 1) 14 14))
  (24 (CONST 0 29))
  (25 (CONCAT (list 20 (CONST 0 1))))
  (26 (CONCAT (list 22 (CONST 0 1))))
  (27 (CONCAT (list (CONST 0 1) (CONST 1 1))))
  (28 (CONST 0 31))
  (29 (CONCAT (list 24 (CONST 4 3))))
  (30 (CONST 0 24))
  (31 (CONCAT (list (CONST 0 1) (CONST 0 1))))
  (32 (CONCAT (list 21 19)))
  (33 (ADD-CARRY 14 29))
  (34 (READ 17 32))
  (35 (CONCAT (list 28 (CONST 0 1))))
  (36 (CONCAT (list 31 31)))
  (37 (SEL 34 (SLICE 0 6)))
  (38 (SEL 34 (SLICE 21 30)))
  (39 (SEL 34 (SLICE 12 31)))
  (40 (SEL 34 (SLICE 7 11)))
  (41 (SEL 34 (list 31)))
  (42 (SEL 34 (SLICE 25 30)))
  (43 (SEL 34 (SLICE 8 11)))
  (44 (SEL 34 (SLICE 20 31)))
  (45 (SEL 34 (SLICE 15 19)))
  (46 (SEL 34 (SLICE 20 24)))
  (47 (SEL 34 (SLICE 12 19)))
  (48 (SEL 34 (SLICE 25 31)))
  (49 (SEL 34 (list 20)))
  (50 (SEL 34 (list 7)))
  (51 (SEL 34 (SLICE 12 14)))
  (52 (CONCAT (list 39 (CONST 0 12))))
  (53 (EQ 45 25))
  (54 (READ 15 45))
  (55 (SEL 33 (SLICE 0 31)))
  (56 (CONCAT (list 36 36)))
  (57 (MUX 53 54 (CONST 0 32)))
  (58 (CONCAT (list 56 56)))
  (59 (SEL 44 (list 11)))
  (60 (:= 8))
  (61 (:= 1))
  (62 (:= 5))
  (63 (:= 13))
  (64 (:= 0))
  (65 (:= 4))
  (66 (:= 7))
  (67 (:= 10))
  (68 (:= 9))
  (69 (:= 6))
  (70 (:= 3))
  (71 (:= 2))
  (72 (:= 11))
  (73 (:= 12))
  (74 (CONCAT (list 41 50 42 43 (CONST 0 1))))
  (75 (SEL 65 (SLICE 0 1)))
  (76 (SEL 65 (list 2)))
  (77 (CONCAT (list 48 40)))
  (78 (EQ 40 25))
  (79 (EQ 73 27))
  (80 (EQ 73 31))
  (81 (READ 15 46))
  (82 (EQ 46 25))
  (83 (SEL 74 (list 12)))
  (84 (CONCAT (list 41 47 49 38 (CONST 0 1))))
  (85 (SEL 83 (list 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)))
  (86 (SEL 59 (list 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)))
  (87 (SEL 84 (list 20)))
  (88 (MUX 70 57 14))
  (89 (SEL 77 (list 11)))
  (90 (SEL 75 (list 1)))
  (91 (SEL 75 (list 0)))
  (92 (SEL 89 (list 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)))
  (93 (CONCAT (list (CONST 0 1) 71)))
  (94 (CONCAT (list 86 44)))
  (95 (OR 60 64))
  (96 (NOT 78))
  (97 (MUX 91 35 94))
  (98 (SEL 93 (SLICE 0 3)))
  (99 (SEL 93 (list 4)))
  (100 (NOT 79))
  (101 (NOT 80))
  (102 (MUX 82 81 (CONST 0 32)))
  (103 (SEL 88 (SLICE 0 30)))
  (104 (SEL 88 (list 31)))
  (105 (SEL 88 (SLICE 1 31)))
  (106 (CONCAT (list 85 74)))
  (107 (AND 95 96))
  (108 (SEL 87 (list 0 0 0 0 0 0 0 0 0 0 0)))
  (109 (SEL 98 (SLICE 0 2)))
  (110 (SEL 98 (list 3)))
  (111 (CONCAT (list 92 77)))
  (112 (CONCAT (list 103 (CONST 0 1))))
  (113 (CONCAT (list 108 84)))
  (114 (MUX 91 111 106))
  (115 (AND 101 100))
  (116 (AND 101 79))
  (117 (SEL 102 (SLICE 0 7)))
  (118 (SEL 102 (SLICE 0 15)))
  (119 (CONCAT (list 104 104)))
  (120 (NOT 104))
  (121 (CONCAT (list 103 104)))
  (122 (SEL 109 (list 2)))
  (123 (SEL 109 (SLICE 0 1)))
  (124 (CONCAT (list 119 119)))
  (125 (CONCAT (list 124 124)))
  (126 (CONCAT (list (CONST 0 1) 105)))
  (127 (CONCAT (list 104 105)))
  (128 (SEL 123 (list 0)))
  (129 (SEL 123 (list 1)))
  (130 (MUX (CONST 0 1) 127 121))
  (131 (CONCAT (list 125 125)))
  (132 (MUX 90 97 114))
  (133 (MUX 91 52 113))
  (134 (MUX (CONST 1 1) 126 112))
  (135 (MUX (CONST 0 1) 126 112))
  (136 (MUX 90 133 35))
  (137 (MUX 76 132 136))
  (138 (MUX 67 102 137))
  (139 (ADD-CARRY 14 137))
  (140 (SUB-CARRY 88 138))
  (141 (LT 88 138))
  (142 (SEL 138 (SLICE 0 4)))
  (143 (AND 88 138))
  (144 (OR 88 138))
  (145 (MUX 128 138 35))
  (146 (SEL 138 (list 31)))
  (147 (XOR 88 138))
  (148 (ADD-CARRY 88 138))
  (149 (CONCAT (list (CONST 0 1) 144)))
  (150 (MUX 128 140 26))
  (151 (SEL 140 (list 32)))
  (152 (NOT 146))
  (153 (XOR 151 120))
  (154 (MUX 129 150 26))
  (155 (SEL 142 (list 3)))
  (156 (SEL 142 (list 1)))
  (157 (SEL 142 (list 0)))
  (158 (SEL 142 (list 2)))
  (159 (SEL 142 (list 4)))
  (160 (MUX 128 149 148))
  (161 (XOR 153 152))
  (162 (MUX 157 88 134))
  (163 (MUX 157 88 130))
  (164 (MUX 157 88 135))
  (165 (SEL 163 (SLICE 0 29)))
  (166 (SEL 163 (SLICE 2 31)))
  (167 (SEL 164 (SLICE 0 29)))
  (168 (SEL 164 (SLICE 2 31)))
  (169 (SEL 162 (SLICE 0 29)))
  (170 (SEL 162 (SLICE 2 31)))
  (171 (MUX 128 161 141))
  (172 (CONCAT (list 165 119)))
  (173 (CONCAT (list 28 171)))
  (174 (CONCAT (list 169 31)))
  (175 (CONCAT (list 167 31)))
  (176 (CONCAT (list 31 168)))
  (177 (CONCAT (list 119 166)))
  (178 (CONCAT (list 31 170)))
  (179 (MUX (CONST 0 1) 177 172))
  (180 (MUX (CONST 1 1) 178 174))
  (181 (MUX (CONST 0 1) 176 175))
  (182 (MUX 156 164 181))
  (183 (MUX 156 163 179))
  (184 (SEL 182 (SLICE 4 31)))
  (185 (SEL 182 (SLICE 0 27)))
  (186 (CONCAT (list 185 36)))
  (187 (MUX 156 162 180))
  (188 (SEL 187 (SLICE 4 31)))
  (189 (SEL 187 (SLICE 0 27)))
  (190 (SEL 183 (SLICE 4 31)))
  (191 (SEL 183 (SLICE 0 27)))
  (192 (CONCAT (list 36 188)))
  (193 (CONCAT (list 191 124)))
  (194 (CONCAT (list 36 184)))
  (195 (MUX (CONST 0 1) 194 186))
  (196 (CONCAT (list 189 36)))
  (197 (MUX (CONST 1 1) 192 196))
  (198 (MUX 158 187 197))
  (199 (CONCAT (list 124 190)))
  (200 (SEL 198 (SLICE 8 31)))
  (201 (SEL 198 (SLICE 0 23)))
  (202 (MUX 158 182 195))
  (203 (MUX (CONST 0 1) 199 193))
  (204 (CONCAT (list 201 56)))
  (205 (SEL 202 (SLICE 8 31)))
  (206 (SEL 202 (SLICE 0 23)))
  (207 (MUX 158 183 203))
  (208 (CONCAT (list 56 205)))
  (209 (CONCAT (list 206 56)))
  (210 (SEL 207 (SLICE 8 31)))
  (211 (SEL 207 (SLICE 0 23)))
  (212 (CONCAT (list 211 125)))
  (213 (CONCAT (list 56 200)))
  (214 (MUX (CONST 0 1) 208 209))
  (215 (MUX 155 202 214))
  (216 (CONCAT (list 125 210)))
  (217 (MUX (CONST 1 1) 213 204))
  (218 (SEL 215 (SLICE 0 15)))
  (219 (SEL 215 (SLICE 16 31)))
  (220 (CONCAT (list 58 219)))
  (221 (MUX 155 198 217))
  (222 (MUX (CONST 0 1) 216 212))
  (223 (MUX 155 207 222))
  (224 (CONCAT (list 218 58)))
  (225 (SEL 221 (SLICE 16 31)))
  (226 (SEL 221 (SLICE 0 15)))
  (227 (SEL 223 (SLICE 16 31)))
  (228 (SEL 223 (SLICE 0 15)))
  (229 (MUX (CONST 0 1) 220 224))
  (230 (CONCAT (list 226 58)))
  (231 (CONCAT (list 58 225)))
  (232 (MUX 159 215 229))
  (233 (CONCAT (list 131 227)))
  (234 (MUX 128 147 232))
  (235 (CONCAT (list 228 131)))
  (236 (CONCAT (list (CONST 0 1) 234)))
  (237 (MUX 129 236 160))
  (238 (MUX (CONST 0 1) 233 235))
  (239 (MUX (CONST 1 1) 231 230))
  (240 (MUX 159 223 238))
  (241 (MUX 159 221 239))
  (242 (MUX 128 35 240))
  (243 (MUX 128 143 241))
  (244 (MUX 129 242 145))
  (245 (MUX 129 243 173))
  (246 (CONCAT (list (CONST 0 1) 244)))
  (247 (MUX 122 154 246))
  (248 (CONCAT (list (CONST 0 1) 245)))
  (249 (MUX 122 248 237))
  (250 (MUX 110 249 247))
  (251 (MUX 99 250 26))
  (252 (SEL 251 (SLICE 0 31)))
  (253 (CONCAT (list (CONST 0 1) 252)))
  (254 (EQ 252 35))
  (255 (SEL 252 (SLICE 0 1)))
  (256 (MUX 61 252 55))
  (257 (SEL 252 (SLICE 2 31)))
  (258 (CONCAT (list 255 (CONST 0 3))))
  (259 (EQ 255 31))
  (260 (EQ 255 27))
  (261 (EQ 255 (CONST 2 2)))
  (262 (MUX 62 139 253))
  (263 (AND 80 259))
  (264 (AND 116 259))
  (265 (NOT 259))
  (266 (SEL 257 (list 29)))
  (267 (SEL 258 (list 2)))
  (268 (SEL 258 (list 3)))
  (269 (SEL 258 (list 1)))
  (270 (SEL 258 (list 0)))
  (271 (SEL 258 (list 4)))
  (272 (AND 116 265))
  (273 (AND 80 265))
  (274 (XOR 254 66))
  (275 (NOT 261))
  (276 (AND 72 274))
  (277 (SEL 266 (list 0 0)))
  (278 (OR 69 276))
  (279 (AND 272 260))
  (280 (NOT 260))
  (281 (AND 273 260))
  (282 (SEL 262 (SLICE 0 31)))
  (283 (NOT 278))
  (284 (CONCAT (list 277 257)))
  (285 (AND 273 280))
  (286 (AND 272 280))
  (287 (MUX 278 23 282))
  (288 (READ 16 284))
  (289 (MUX 283 287 55))
  (290 (SEL 288 (SLICE 0 30)))
  (291 (SEL 288 (SLICE 16 31)))
  (292 (SEL 288 (SLICE 1 31)))
  (293 (SEL 288 (SLICE 0 7)))
  (294 (SEL 288 (SLICE 24 31)))
  (295 (SEL 288 (SLICE 0 15)))
  (296 (SEL 288 (SLICE 0 23)))
  (297 (SEL 288 (SLICE 8 31)))
  (298 (CONCAT (list 117 296)))
  (299 (CONCAT (list 297 117)))
  (300 (CONCAT (list 118 295)))
  (301 (CONCAT (list 294 117 295)))
  (302 (CONCAT (list 294 118 293)))
  (303 (AND 285 261))
  (304 (AND 285 275))
  (305 (CONCAT (list 290 (CONST 0 1))))
  (306 (CONCAT (list (CONST 0 1) 292)))
  (307 (CONCAT (list 291 118)))
  (308 (CONCAT (list 291 117 293)))
  (309 (MUX 263 35 299))
  (310 (MUX (CONST 0 1) 306 305))
  (311 (MUX 281 309 308))
  (312 (MUX 303 311 301))
  (313 (MUX 304 312 298))
  (314 (MUX 270 288 310))
  (315 (MUX 264 313 307))
  (316 (SEL 314 (SLICE 0 29)))
  (317 (SEL 314 (SLICE 2 31)))
  (318 (MUX 279 315 302))
  (319 (CONCAT (list 31 317)))
  (320 (CONCAT (list 316 31)))
  (321 (MUX 286 318 300))
  (322 (MUX 115 321 102))
  (323 (MUX (CONST 0 1) 319 320))
  (324 (MUX 269 314 323))
  (325 (SEL 324 (SLICE 0 27)))
  (326 (SEL 324 (SLICE 4 31)))
  (327 (CONCAT (list 325 36)))
  (328 (CONCAT (list 36 326)))
  (329 (MUX (CONST 0 1) 328 327))
  (330 (MUX 267 324 329))
  (331 (SEL 330 (SLICE 0 23)))
  (332 (SEL 330 (SLICE 8 31)))
  (333 (CONCAT (list 56 332)))
  (334 (CONCAT (list 331 56)))
  (335 (MUX (CONST 0 1) 333 334))
  (336 (MUX 268 330 335))
  (337 (SEL 336 (SLICE 16 31)))
  (338 (SEL 336 (SLICE 0 15)))
  (339 (CONCAT (list 58 337)))
  (340 (CONCAT (list 338 58)))
  (341 (MUX (CONST 0 1) 339 340))
  (342 (MUX 271 336 341))
  (343 (SEL 342 (SLICE 0 15)))
  (344 (SEL 342 (SLICE 0 7)))
  (345 (CONCAT (list 18 343)))
  (346 (SEL 343 (list 15)))
  (347 (CONCAT (list 30 344)))
  (348 (SEL 344 (list 7)))
  (349 (SEL 346 (list 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)))
  (350 (SEL 348 (list 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)))
  (351 (CONCAT (list 349 343)))
  (352 (CONCAT (list 350 344)))
  (353 (MUX 63 345 351))
  (354 (MUX 63 347 352))
  (355 (MUX 80 35 354))
  (356 (MUX 116 355 353))
  (357 (MUX 115 356 288))
  (358 (MUX 64 256 357))
  (16 (WRITE 284 322 68))
  (15 (WRITE 40 358 107))
  (14 (:= 289))))

(time 
  (define control-sigs
    (synth-instrs!  
                #:semantics rv-semantics
                #:steps 1
                #:sketch riscv
                #:reg-state (list "pc")
                #:mem-state (list "imem" "dmem" "rf")
                ))
  (printf "done!~n"))
